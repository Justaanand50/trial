<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Submit Complaint</title>
Â  Â  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
Â  Â  <style>
Â  Â  Â  Â  /* CSS for the new camera feature */
Â  Â  Â  Â  .camera-container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #camera-stream {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  background-color: #000;
Â  Â  Â  Â  }
Â  Â  Â  Â  #capture-button {
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #photo-canvas {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
        /* NEW: Style for displaying the captured photo */
        #captured-photo {
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            border: 1px solid #ccc;
            display: none; /* Hidden by default */
        }
Â  Â  </style>
</head>
<body>
Â  Â  <header>
Â  Â  Â  Â  <div class="logo-container">
Â  Â  Â  Â  Â  Â  <span class="app-title">Sahaayak</span>
Â  Â  Â  Â  </div>
Â  Â  </header>
Â  Â  
Â  Â  <h2>Submit Civic Complaint</h2>

Â  Â  <form id="complaintForm" enctype="multipart/form-data">
Â  Â  Â  Â  <label for="citizen_name">Name:</label>
Â  Â  Â  Â  <input type="text" id="citizen_name" name="citizen_name" required placeholder="Enter your full name"><br><br>

Â  Â  Â  Â  <label for="description">Description:</label>
Â  Â  Â  Â  <div class="voice-input-container">
Â  Â  Â  Â  Â  Â  <input type="text" id="description" name="description" required placeholder="Describe the issue or use voice input">
Â  Â  Â  Â  Â  Â  <button type="button" id="voiceBtn" class="btn-voice" onclick="startVoiceInput()" title="Record Voice Description">
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ¤ Record
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="voiceStatus" class="voice-status"></div><br>

Â  Â  Â  Â  <label for="category">Category:</label>
Â  Â  Â  Â  <select id="category" name="category" required>
Â  Â  Â  Â  Â  Â  <option value="Road">Road Issues</option>
Â  Â  Â  Â  Â  Â  <option value="Streetlight">Streetlight</option>
Â  Â  Â  Â  Â  Â  <option value="Sanitation">Sanitation</option>
Â  Â  Â  Â  Â  Â  <option value="Water">Water Supply</option>
Â  Â  Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  Â  Â  </select><br><br>

Â  Â  Â  Â  <label>Photo:</label>
Â  Â  Â  Â  <div class="camera-container">
Â  Â  Â  Â  Â  Â  <video id="camera-stream" playsinline autoplay muted></video>
            <img id="captured-photo" alt="Captured Photo" style="display: none;">
Â  Â  Â  Â  Â  Â  <button type="button" id="capture-button" class="btn">Take Photo ğŸ“¸</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <canvas id="photo-canvas"></canvas>
Â  Â  Â  Â  <p id="photo-status" class="photo-status"></p>
Â  Â  Â  Â  <input type="hidden" id="photo-data" name="photo_data">
Â  Â  Â  Â  
Â  Â  Â  Â  <label>Voice Note (Optional):</label>
Â  Â  Â  Â  <div class="voice-recording-container">
Â  Â  Â  Â  Â  Â  <button type="button" id="recordBtn" class="btn" onclick="startRecording()">ğŸ¤ Record</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="stopBtn" class="btn" onclick="stopRecording()" disabled>â¹ï¸ Stop</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="playBtn" class="btn" onclick="playRecording()" disabled>â–¶ï¸ Play</button>
Â  Â  Â  Â  Â  Â  <button type="button" id="clearBtn" class="btn" onclick="clearRecording()" disabled>ğŸ—‘ï¸ Clear</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="recordingStatus" class="recording-status"></div>
Â  Â  Â  Â  <audio id="audioPlayback" controls class="audio-playback"></audio><br>

Â  Â  Â  Â  <p><b>Your Location:</b></p>
Â  Â  Â  Â  <p id="latlong">Detecting...</p>
Â  Â  Â  Â  <p id="address">Detecting...</p>
Â  Â  Â  Â  <button type="button" onclick="getLocation()">Retry Location</button>

Â  Â  Â  Â  <input type="hidden" id="latitude" name="latitude">
Â  Â  Â  Â  <input type="hidden" id="longitude" name="longitude">
Â  Â  Â  Â  <input type="hidden" id="addressInput" name="address">

Â  Â  Â  Â  <button type="submit" class="btn">Submit Complaint</button>
Â  Â  </form>

Â  Â  <div id="trackingStatus" style="display:none; margin-top:20px;"></div>

Â  Â  <script>
Â  Â  Â  Â  // Start of new camera-specific JavaScript
Â  Â  Â  Â  const video = document.getElementById('camera-stream');
Â  Â  Â  Â  const captureButton = document.getElementById('capture-button');
Â  Â  Â  Â  const canvas = document.getElementById('photo-canvas');
Â  Â  Â  Â  const photoStatus = document.getElementById('photo-status');
Â  Â  Â  Â  const photoDataInput = document.getElementById('photo-data');
        // New image element for displaying the photo
        const capturedPhoto = document.getElementById('captured-photo');
        
Â  Â  Â  Â  let mediaStream = null;

Â  Â  Â  Â  async function startCamera() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Request access to the video stream, specifically the rear-facing camera
Â  Â  Â  Â  Â  Â  Â  Â  const constraints = { video: { facingMode: 'environment' } };
Â  Â  Â  Â  Â  Â  Â  Â  mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
Â  Â  Â  Â  Â  Â  Â  Â  video.srcObject = mediaStream;
Â  Â  Â  Â  Â  Â  Â  Â  photoStatus.textContent = 'Camera ready. Tap the button to take a picture.';
Â  Â  Â  Â  Â  Â  Â  Â  captureButton.disabled = false;
                video.style.display = 'block'; // Show video stream
                capturedPhoto.style.display = 'none'; // Hide captured photo
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error accessing camera:', err);
Â  Â  Â  Â  Â  Â  Â  Â  photoStatus.textContent = 'Error: Could not access camera. Please check permissions.';
Â  Â  Â  Â  Â  Â  Â  Â  captureButton.disabled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopCamera() {
Â  Â  Â  Â  Â  Â  if (mediaStream) {
Â  Â  Â  Â  Â  Â  Â  Â  mediaStream.getTracks().forEach(track => track.stop());
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  captureButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  canvas.width = video.videoWidth;
Â  Â  Â  Â  Â  Â  canvas.height = video.videoHeight;
Â  Â  Â  Â  Â  Â  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Convert the canvas image to a data URL and set it to a hidden input
Â  Â  Â  Â  Â  Â  const photoData = canvas.toDataURL('image/jpeg');
Â  Â  Â  Â  Â  Â  photoDataInput.value = photoData;
Â  Â  Â  Â  Â  Â  photoStatus.textContent = 'Photo taken successfully! It will be submitted with your complaint.';
Â  Â  Â  Â  Â  Â  
            // Display the captured photo and hide the camera stream
            capturedPhoto.src = photoData;
            capturedPhoto.style.display = 'block';
            video.style.display = 'none';
            stopCamera();
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Start the camera when the page loads
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', startCamera);
Â  Â  Â  Â  
Â  Â  Â  Â  // Stop camera when navigating away
Â  Â  Â  Â  window.addEventListener('beforeunload', stopCamera);

Â  Â  Â  Â  // End of new camera-specific JavaScript
Â  Â  Â  Â  // --------------------------------------------------------------------------------------------------------------------------------
Â  Â  Â  Â  
Â  Â  Â  Â  // ---------- Existing Voice Input & Recording, GPS & Reverse Geocoding, Form Submission & Tracking ----------
Â  Â  Â  Â  let recognition, isRecording = false;
Â  Â  Â  Â  let mediaRecorder, audioChunks = [], recordedAudioBlob = null, audioStream = null;

Â  Â  Â  Â  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
Â  Â  Â  Â  Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  Â  Â  Â  Â  recognition = new SpeechRecognition();
Â  Â  Â  Â  Â  Â  recognition.continuous = false;
Â  Â  Â  Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  Â  Â  Â  recognition.lang = 'en-US';

Â  Â  Â  Â  Â  Â  recognition.onstart = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isRecording = true;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('voiceBtn').textContent = 'ğŸ”´ Stop';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('voiceBtn').classList.add('recording');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('voiceStatus').textContent = 'Listening... Speak now';
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('description').value = event.results[0][0].transcript;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('voiceStatus').textContent = 'Voice recorded successfully!';
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Speech recognition error:', event.error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('voiceStatus').textContent = 'Error: ' + event.error;
Â  Â  Â  Â  Â  Â  Â  Â  resetVoiceButton();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onend = resetVoiceButton;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('voiceBtn').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function startVoiceInput() {
Â  Â  Â  Â  Â  Â  if (!recognition) return;
Â  Â  Â  Â  Â  Â  isRecording ? recognition.stop() : recognition.start();
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetVoiceButton() {
Â  Â  Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  Â  Â  document.getElementById('voiceBtn').textContent = 'ğŸ¤ Record';
Â  Â  Â  Â  Â  Â  document.getElementById('voiceBtn').classList.remove('recording');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function startRecording() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  Â  Â  Â  Â  mediaRecorder = new MediaRecorder(audioStream);
Â  Â  Â  Â  Â  Â  Â  Â  audioChunks = [];

Â  Â  Â  Â  Â  Â  Â  Â  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
Â  Â  Â  Â  Â  Â  Â  Â  mediaRecorder.onstop = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('playBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clearBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').textContent = 'Recording completed! Click Play to review.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').style.color = '#28a745';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audioStream.getTracks().forEach(t => t.stop());
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  mediaRecorder.start();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordBtn').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('stopBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').textContent = 'Recording... Click Stop when finished.';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').style.color = '#dc3545';
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Microphone error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').textContent = 'Error: Could not access microphone.';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').style.color = '#dc3545';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function stopRecording() {
Â  Â  Â  Â  Â  Â  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
Â  Â  Â  Â  Â  Â  document.getElementById('recordBtn').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('stopBtn').disabled = true;
Â  Â  Â  Â  }

Â  Â  Â  Â  function playRecording() {
Â  Â  Â  Â  Â  Â  if (recordedAudioBlob) {
Â  Â  Â  Â  Â  Â  Â  Â  const audioUrl = URL.createObjectURL(recordedAudioBlob);
Â  Â  Â  Â  Â  Â  Â  Â  const audioPlayback = document.getElementById('audioPlayback');
Â  Â  Â  Â  Â  Â  Â  Â  audioPlayback.src = audioUrl;
Â  Â  Â  Â  Â  Â  Â  Â  audioPlayback.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  audioPlayback.play();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').textContent = 'Playing recording...';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearRecording() {
Â  Â  Â  Â  Â  Â  recordedAudioBlob = null; audioChunks = [];
Â  Â  Â  Â  Â  Â  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
Â  Â  Â  Â  Â  Â  if (audioStream) audioStream.getTracks().forEach(t => t.stop());
Â  Â  Â  Â  Â  Â  document.getElementById('recordBtn').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('stopBtn').disabled = true;
Â  Â  Â  Â  Â  Â  document.getElementById('playBtn').disabled = true;
Â  Â  Â  Â  Â  Â  document.getElementById('clearBtn').disabled = true;
Â  Â  Â  Â  Â  Â  document.getElementById('audioPlayback').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('recordingStatus').textContent = 'Recording cleared.';
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------- GPS & Reverse Geocoding ----------
Â  Â  Â  Â  async function getLocation() {
Â  Â  Â  Â  Â  Â  const latEl = document.getElementById('latitude');
Â  Â  Â  Â  Â  Â  const lonEl = document.getElementById('longitude');
Â  Â  Â  Â  Â  Â  const latlongEl = document.getElementById('latlong');
Â  Â  Â  Â  Â  Â  const addressEl = document.getElementById('address');
Â  Â  Â  Â  Â  Â  const addressInput = document.getElementById('addressInput');

Â  Â  Â  Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  latlongEl.innerText = 'Geolocation not supported';
Â  Â  Â  Â  Â  Â  Â  Â  addressEl.innerText = 'Geolocation not supported';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  async (pos) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lat = pos.coords.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lon = pos.coords.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latEl.value = lat; lonEl.value = lon;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latlongEl.innerText = `Latitude: ${lat}, Longitude: ${lon}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const address = data.display_name || "Address not found";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addressEl.innerText = `Address: ${address}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Reverse geocoding failed:', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addressEl.innerText = 'Address not available';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  (err) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Geolocation error:', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let msg = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  switch (err.code) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case err.PERMISSION_DENIED: msg = 'User denied the request for Geolocation.'; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case err.POSITION_UNAVAILABLE: msg = 'Location information is unavailable.'; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case err.TIMEOUT: msg = 'Request timed out.'; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  default: msg = 'An unknown error occurred.'; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latlongEl.innerText = msg; addressEl.innerText = msg;
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  }

Â  Â  Â  Â  // Initial call
Â  Â  Â  Â  getLocation();

Â  Â  Â  Â  // ---------- Form Submission & Tracking ----------
Â  Â  Â  Â  let trackingId = null, lastStatus = null, pollInterval = null;
Â  Â  Â  Â  document.getElementById('complaintForm').addEventListener('submit', function (e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Append all form data
Â  Â  Â  Â  Â  Â  formData.append('citizen_name', document.getElementById('citizen_name').value);
Â  Â  Â  Â  Â  Â  formData.append('description', document.getElementById('description').value);
Â  Â  Â  Â  Â  Â  formData.append('category', document.getElementById('category').value);
Â  Â  Â  Â  Â  Â  formData.append('latitude', document.getElementById('latitude').value);
Â  Â  Â  Â  Â  Â  formData.append('longitude', document.getElementById('longitude').value);
Â  Â  Â  Â  Â  Â  formData.append('address', document.getElementById('addressInput').value);

Â  Â  Â  Â  Â  Â  // Append the image data from the canvas
Â  Â  Â  Â  Â  Â  const imageData = photoDataInput.value;
Â  Â  Â  Â  Â  Â  if (imageData) {
Â  Â  Â  Â  Â  Â  Â  Â  const byteString = atob(imageData.split(',')[1]);
Â  Â  Â  Â  Â  Â  Â  Â  const mimeString = imageData.split(',')[0].split(':')[1].split(';')[0];
Â  Â  Â  Â  Â  Â  Â  Â  const ab = new ArrayBuffer(byteString.length);
Â  Â  Â  Â  Â  Â  Â  Â  const ia = new Uint8Array(ab);
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < byteString.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ia[i] = byteString.charCodeAt(i);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const photoBlob = new Blob([ab], { type: mimeString });
Â  Â  Â  Â  Â  Â  Â  Â  formData.append('photo', photoBlob, 'captured_photo.jpg');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (recordedAudioBlob) {
Â  Â  Â  Â  Â  Â  Â  Â  formData.append('voice_note', recordedAudioBlob, 'voice_recording.webm');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  fetch('/submit', { method: 'POST', body: formData })
Â  Â  Â  Â  Â  Â  Â  Â  .then(r => r.text())
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let match = data.match(/ID\s*[:=]\s*(\d+)/i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trackingId = match ? match[1] : null;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("trackingStatus").style.display = "block";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("trackingStatus").innerHTML = `âœ… Complaint submitted!<br>Your tracking ID is: <b>${trackingId ? trackingId : 'N/A'}</b>. Status: <span id='trackStatusBadge' class='status pending'>Pending</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.reset();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearRecording();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  getLocation();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopCamera(); // Stop the camera after submission

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (trackingId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastStatus = 'Pending';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pollInterval = setInterval(() => pollStatus(trackingId), 15000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => alert('Error: ' + err));
Â  Â  Â  Â  });

Â  Â  Â  Â  async function pollStatus(id) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`/api/complaints?id=${id}`);
Â  Â  Â  Â  Â  Â  Â  Â  const complaints = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (!complaints || complaints.length === 0) return;

Â  Â  Â  Â  Â  Â  Â  Â  const status = complaints[0].status;
Â  Â  Â  Â  Â  Â  Â  Â  const badge = document.getElementById('trackStatusBadge');
Â  Â  Â  Â  Â  Â  Â  Â  badge.textContent = status;
Â  Â  Â  Â  Â  Â  Â  Â  badge.className = 'status ' + (status === 'Resolved' ? 'resolved' : (status === 'In Progress' ? 'inprogress' : 'pending'));

Â  Â  Â  Â  Â  Â  Â  Â  if (status !== lastStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendStatusNotification(status);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastStatus = status;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (status === 'Resolved' && pollInterval) clearInterval(pollInterval);
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function sendStatusNotification(status) {
Â  Â  Â  Â  Â  Â  if (window.Notification && Notification.permission === "granted") {
Â  Â  Â  Â  Â  Â  Â  Â  new Notification(`Complaint Status Updated: ${status}`);
Â  Â  Â  Â  Â  Â  } else if (window.Notification && Notification.permission !== "denied") {
Â  Â  Â  Â  Â  Â  Â  Â  Notification.requestPermission().then(permission => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (permission === "granted") new Notification(`Complaint Status Updated: ${status}`);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>